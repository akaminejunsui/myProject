b$.module('b$.view.bdom',function(){var DesignElement=b$.bdom.getNamespace('http://backbase.com/2012/view').getClass('DesignElement');var ViewElement=DesignElement.extend(null,{namespaceURI:'http://backbase.com/2013/view',localName:'ViewElement',getHTMLNode:function(){return this.getDisplay();}});});b$.module("b$.portal.view.bdom.default",function(){var scope=function(){return this}();var BDOMNamespace=b$.bdom.Namespace;var Component=b$.view.bdom.Component;var ViewElement=b$.bdom.getNamespace('http://backbase.com/2013/view').getClass('ViewElement');var Perspective=b$.view.perspective.Perspective;var PerspectiveType=b$.view.perspective.PerspectiveType;var PerspectiveParameters=b$.view.perspective.PerspectiveParameters;var SimpleURITemplate=b$._private.template.SimpleURITemplate;var htmlAPI=b$._private.htmlAPI;var XMLHelper=b$._private.xml;var NSPortalDefault=BDOMNamespace.extend(function(namespaceURI){BDOMNamespace.call(this,namespaceURI);},{});var NS=new NSPortalDefault('http://backbase.com/2013/portalView');this.NS=NS;var refreshHTML=function(bdomModel,elm,callback,errCallback){var This=this;b$.portal.portalServer.loadItemHTML(bdomModel.originalItem,function(text,res){var head=text.substring(0,text.indexOf('<body>'))+'</html>';var body=text.substring(text.indexOf('<body>')+6,text.indexOf('<script type="text/backbase-xml'));var xmp='';if(text.indexOf('<script type="text/backbase-xml">')!==-1){xmp=text.substring(text.indexOf('<script type="text/backbase-xml">')+33,text.indexOf('</script>',text.indexOf('<script type="text/backbase-xml">')+33));}var xml=XMLHelper.parse(head);b$.portal._private.definition.getResourcesFromDefinition(xml,'',function(){var htmlNode=htmlAPI.createElementFromString(body);var ownerDocument=bdomModel.ownerDocument;bdomModel.destroy();var xml=XMLHelper.parse(xmp);var bres=b$.portal.importPortalModel(xml,ownerDocument,null,htmlNode);if(callback)callback(bres,res);var bdom=htmlNode.viewController;if(bdom.ownerDocument.documentElement.designMode)bdom.enableDesignMode();},function(){var htmlNode=htmlAPI.createElementFromString('<span>This part of the page can\'t be rendered </span>');htmlNode.viewController=elm.viewController;elm.appendChild(htmlNode);var xml=XMLHelper.parse(xmp);var item=b$.portal.portalServer.itemXMLDOC2JSON(xml);bdomModel.setItem(item);if(callback)callback();});},errCallback,true);};var sProfile={'ADMIN':0,'CREATOR':-1,'COLLABORATOR':-2,'CONTRIBUTOR':-3,'CONSUMER':-4};var PortalViewElement=ViewElement.extend(function(){ViewElement.apply(this,arguments);if(this.ownerDocument.defaultDragHandlers){this.addHandlers(this.ownerDocument.defaultDragHandlers);};},{localName:'portalViewElement',namespaceURI:'http://backbase.com/2013/portalView',insertDisplayChild:function(bdom,bdomBefore){if(!(bdom.model&&bdom.model._ssr)&&bdom.injectDisplaySelf(bdom,bdomBefore)&&bdom.htmlNode){if(!bdom.getPreference){var oArea=this.getDisplay('area')||this.getDisplay();oArea.appendChild(bdom.htmlNode);return;};var aAreas=this.getDisplay('area',true)||this.getDisplay();var iChildAreaPref=parseInt(bdom.getPreference('area'),10)||0;var iChildArea=aAreas[iChildAreaPref]?iChildAreaPref:aAreas.length-1;var iChildOrder=parseInt(bdom.getPreference('order'),10)||0;var oAreaBefore;if(aAreas[iChildArea].childNodes.length){for(var i=aAreas[iChildArea].childNodes.length-1;i>=0;i--){if(aAreas[iChildArea].childNodes[i]!==bdom.htmlNode&&aAreas[iChildArea].childNodes[i].viewController){var iOrder=parseInt(aAreas[iChildArea].childNodes[i].viewController.getPreference('order'),10);if(iOrder>iChildOrder){oAreaBefore=aAreas[iChildArea].childNodes[i].viewController;};};};};if(bdomBefore&&bdomBefore.htmlNode){bdomBefore.htmlNode.parentNode.insertBefore(bdom.htmlNode,bdomBefore.htmlNode);}else{if(oAreaBefore){aAreas[iChildArea].insertBefore(bdom.htmlNode,oAreaBefore.htmlNode);}else{aAreas[iChildArea].appendChild(bdom.htmlNode);};};};},dragIsTarget:function(){return this.isPossibleDragTarget;},refreshHTML:function(callback,errCallback){var targetParentModel=this.model.parentNode;var ownerDocument=this.ownerDocument;refreshHTML(this.model,null,function(bres,res){var parentView,bresView;targetParentModel.appendChild(bres);parentView=ownerDocument.all[b$.portal.portalReflector.getID(targetParentModel)];bresView=ownerDocument.all[b$.portal.portalReflector.getID(bres)];parentView.insertDisplayChild(bresView);if(callback){callback(bresView,res);}});return;var This=this;b$.portal.portalServer.loadItemHTML(this.model.getJSON(),function(text){var head=text.substring(0,text.indexOf('<body>'))+'</html>';var body=text.substring(text.indexOf('<body>')+6,text.indexOf('<script type="text/backbase-xml"'));var xmp='';if(text.indexOf('<script type="text/backbase-xml">')!==-1){xmp=text.substring(text.indexOf('<script type="text/backbase-xml">')+33,text.indexOf('</script>',text.indexOf('<script type="text/backbase-xml">')+33));}var xml=XMLHelper.parse(head);b$.portal._private.definition.getResourcesFromDefinition(xml,'',function(){if(This.htmlNode!=null)This.htmlNode.innerHTML='';var htmlNode=htmlAPI.createElementFromString(body);if(!htmlNode){htmlNode=htmlAPI.createElementFromString('<span>'+body+'</span>');}htmlNode.viewController=This.htmlNode.parentNode.viewController;This.htmlNode.parentNode.insertBefore(htmlNode,This.htmlNode);var parent=This.model.parentNode;This.model.destroy();var xml=XMLHelper.parse(xmp);var item=b$.portal.portalServer.itemXMLDOC2JSON(xml);b$.portal._buildModelFromJSON(parent.ownerDocument,item,parent);if(callback)callback();});},errCallback,true);},loadChildren:function(child,callback){var aChildren=[];if(!this.model._children){return};if(child){aChildren.push(child);}else{aChildren=this.model._children;};var that=this;for(var i=aChildren.length-1;i>=0;i--){if(b$.portal.portalModel.getElementById(aChildren[i].name)){break;};var loadItemHTMLCallback=function(response,xhr){var head=response.substring(0,response.indexOf('<body>'))+'</html>';var body=response.substring(response.indexOf('<body>')+6,response.indexOf('<script type="text/backbase-xml'));var xmp='';if(response.indexOf('<script type="text/backbase-xml">')!==-1){xmp=response.substring(response.indexOf('<script type="text/backbase-xml">')+33,response.indexOf('</script>',response.indexOf('<script type="text/backbase-xml">')+33));};var resourceCallback=function(){var htmlNode=b$._private.htmlAPI.createElementFromString(body);var modelXml=b$._private.xml.parse(xmp);var htmlArea=0;var order=0;var Nav=navigator.userAgent.toLowerCase();if(!(Nav.indexOf('msie')!=-1)&&parseInt(Nav.split('msie')[1])>9){htmlArea=b$._private.xml.textContent(b$.ua.querySelector(modelXml,'property[name=area] value'))||0;order=b$._private.xml.textContent(b$.ua.querySelector(modelXml,'property[name=order] value'))||0;};var targetArea=that.htmlAreas[htmlArea];var bAppend=true;var before=null;for(var j=0;j<targetArea.childNodes.length;j++){if(targetArea.childNodes[j].getAttribute('data-pid')==htmlNode.getAttribute('data-pid')){bAppend=false;break;}else{if(order<targetArea.childNodes[j].viewController.getPreference('order')){before=targetArea.childNodes[j];};};};if(bAppend){if(before){targetArea.insertBefore(htmlNode,before);}else{targetArea.appendChild(htmlNode);};};var bres=b$.portal.importPortalModel(modelXml,b$.portal.portalModel,that.model,htmlNode);if(callback)callback(htmlNode.viewController);};var headXML=b$._private.xml.parse(head);b$.portal._private.definition.getResourcesFromDefinition(headXML,'',resourceCallback);};b$.portal.portalServer.loadItemHTML(aChildren[i],loadItemHTMLCallback,null,true,-1,null);};},getPreference:function(name){if(this.model)return this.model.getPreference(name);return this.getAttribute(name);},setPreference:function(name,value){return this.model.setPreference(name,value);},isPreference:function(name){var p=this.getPreference(name);return p!=null&&p!='';},getAreaPreference:function(){if(this.area===undefined){if(this.model){var v=parseInt(this.model.getPreference('area'),10);if(isNaN(v))v=0;}else{var v=parseInt(this.getAttribute('area'),10);if(isNaN(v))v=0;}return v;}else return this.area;},getOrderPreference:function(){if(this.order===undefined){if(this.model){var v=parseInt(this.model.getPreference('order'),10);if(isNaN(v))v=0;}else{var v=parseInt(this.getAttribute('order'),10);if(isNaN(v))v=0;}return v;}else return this.order;},m_dragEnter:function(event,dm){var secProfile=sProfile[this.model.securityProfile];if(secProfile<sProfile['CONTRIBUTOR']){return false;}var x=event.clientX;var y=event.clientY;this.appendChild(this.ownerDocument.dragIndicator);},m_dragOut:function(event,dm){var secProfile=sProfile[this.model.securityProfile];if(secProfile<sProfile['CONTRIBUTOR']){return false;}var x=event.clientX;var y=event.clientY;var html=this.ownerDocument.dragIndicator.getDisplay();if(html){html.parentNode.removeChild(html);this.removeChild(this.ownerDocument.dragIndicator);};delete this.tmp_lastTargetAreaId;var aChildren=this.childNodes;for(var i=0;i<aChildren.length;i++){aChildren[i].tmp_order=aChildren[i].order;delete aChildren[i].area;delete aChildren[i].order;}this.reflow();},m_dragMove:function(event,dm){var secProfile=sProfile[this.model.securityProfile];if(secProfile<sProfile['CONTRIBUTOR']){return false;}var scrollTop=document.body.scrollTop?document.body.scrollTop:document.body.parentNode.scrollTop?document.body.parentNode.scrollTop:0;var scrollLeft=document.body.scrollLeft?document.body.scrollLeft:document.body.parentNode.scrollLeft?document.body.parentNode.scrollLeft:0;var x=event.clientX+scrollLeft;var y=event.clientY+scrollTop;var htmlAreas=this.getDisplay('area',true);if(!htmlAreas.length)htmlAreas=htmlAPI.findCaptureClass('bp-area',this.htmlNode);var targetAreaId=null;var closestTargetAreaId=null;var dt=Infinity;var s='';for(var i=0;i<htmlAreas.length;i++){var oCoord=htmlAPI.getBoxObject(htmlAreas[i],'border');if(isInside(x,y,oCoord.x,oCoord.y,oCoord.w,oCoord.h)){targetAreaId=i;break;}var d=Math.abs((oCoord.x+oCoord.w/2)-x)+Math.abs((oCoord.y+oCoord.h/2)-y);if(d<dt){dt=d;closestTargetAreaId=i;}}if(targetAreaId==null){if(this.tmp_lastTargetAreaId)targetAreaId=this.tmp_lastTargetAreaId;else if(closestTargetAreaId==null)targetAreaId=0;else targetAreaId=closestTargetAreaId;}this.tmp_lastTargetAreaId=targetAreaId;var dragComponent=null;var aBEList=dm.dataTransfer.getData('x-bb-nodelist');if(aBEList&&aBEList[0])dragComponent=aBEList[0];var target=htmlAreas[targetAreaId];dm.__tmpArea=targetAreaId;dm.__tmpOrder=0;this.ownerDocument.dragIndicator.area=targetAreaId;var areas=this.getAreaOrderedChildren();var aChildren=areas[targetAreaId];var bFound=false;if(aChildren){for(var i=0;i<aChildren.length;i++){if(aChildren[i]!=this.ownerDocument.dragIndicator){if(!bFound){var oCoord=htmlAPI.getBoxObject(aChildren[i].htmlNode,'border');if((this.layout.dir.direction=='horizontal'&&x<oCoord.x+(oCoord.w/2))||(this.layout.dir.direction=='vertical'&&y<oCoord.y+(oCoord.h/2))){bFound=true;this.ownerDocument.dragIndicator.order=dm.__tmpOrder;var htmlDrag=this.ownerDocument.dragIndicator.getDisplay();var kid=aChildren[i].getDisplay();kid.parentNode.insertBefore(htmlDrag,kid);dm.__tmpOrder++;if(dragComponent==aChildren[i].model){htmlDrag.display='none';}else
htmlDrag.display='block';}}aChildren[i].order=dm.__tmpOrder;dm.__tmpOrder++;}}}if(!bFound){this.ownerDocument.dragIndicator.order=dm.__tmpOrder;if(!htmlAreas[targetAreaId]){console.log('____________________________________________',this)}htmlAreas[targetAreaId].appendChild(this.ownerDocument.dragIndicator.getDisplay());}var dragIndicator=this.ownerDocument.dragIndicator;var dragComponent;var nodeList=dm.dataTransfer.getData('x-bb-nodelist');if(nodeList)dragComponent=nodeList[0];dragIndicator.getDisplay().style.display='block';if(!dm.dragOptions.htmlNode.catalogItemJson){if(dragComponent.parentNode==dragIndicator.parentNode){if(dragComponent.getAreaPreference()==dragIndicator.area){if(dragComponent.order+1==dragIndicator.order||dragComponent.order-1==dragIndicator.order){dragIndicator.getDisplay().style.display='none';}}}}this.reflow();return;},m_dragDrop:function(event,dm,belmDrop){var secProfile=sProfile[this.model.securityProfile];if(secProfile<sProfile['CONTRIBUTOR']){return false;}var child=belmDrop;if(child.isCatalog){}else{var orgParent=child.parentNode;var aChildren=orgParent.childNodes;if(this!=orgParent){for(var i=0;i<aChildren.length;i++){if(child!=aChildren[i]){aChildren[i].model.setPreference('order',aChildren[i].tmp_order);aChildren[i].model.save();}}}}var aChildren=this.childNodes;for(var i=0;i<aChildren.length;i++){if(child!=aChildren[i]&&aChildren[i].tmp_order){var pref=this.model.ownerDocument.createPreference('order','double');pref.value=parseFloat(aChildren[i].tmp_order);aChildren[i].model.setPreferenceNode(pref);aChildren[i].model.save();}}if(child.isCatalog&&dm.dragOptions.htmlNode&&dm.dragOptions.htmlNode.catalogItemJson){var bdom=this.model.createExtendedElementFromJSON(dm.dragOptions.htmlNode.catalogItemJson);if(dm.dragOptions.htmlNode.catalogItemJson.children){for(var i=0,l=dm.dragOptions.htmlNode.catalogItemJson.children.length;i<l;i++){var bdomCld=this.model.createExtendedElementFromJSON(dm.dragOptions.htmlNode.catalogItemJson.children[i]);bdom.appendChild(bdomCld,true);}}var targetParentModel=this.model;bdom.parentItemName=targetParentModel.name;var p=bdom.getPreferenceNode('area');if(p)bdom.setPreference('area',this.ownerDocument.dragIndicator.area+'');else{p=this.model.ownerDocument.createPreference('area','string');p.value=this.ownerDocument.dragIndicator.area+'';bdom.setPreferenceNode(p);}var p=bdom.getPreferenceNode('order');if(p)bdom.setPreference('order',this.ownerDocument.dragIndicator.order+'');else{p=this.model.ownerDocument.createPreference('order','double');p.value=this.ownerDocument.dragIndicator.order+'';bdom.setPreferenceNode(p);}var This=this;bdom.save(function(){if(!bdom.contextItemName){targetParentModel.appendChild(bdom);}else{refreshHTML(bdom,This.htmlNode,function(bres){var parentView,bresView;targetParentModel.appendChild(bres);parentView=This.ownerDocument.all[b$.portal.portalReflector.getID(targetParentModel)];bresView=This.ownerDocument.all[b$.portal.portalReflector.getID(bres)];parentView.insertDisplayChild(bresView);});}});}else{child.model.setPreference('area',this.ownerDocument.dragIndicator.area.toString());var p=child.model.getPreferenceNode('order');if(p)child.model.setPreference('order',this.ownerDocument.dragIndicator.order+'');else{p=this.model.ownerDocument.createPreference('order','double');p.value=this.ownerDocument.dragIndicator.order+'';child.model.setPreferenceNode(p);}child.model.parentItemName=this.model.name;this.model.appendChild(child.model);child.model.save();}if(orgParent)orgParent.reflow();this.reflow();},createPerspective:function(oPerspectiveType,oParameters){return new Perspective(new SimpleURITemplate("/","page"),oPerspectiveType,oParameters);},getCurrentPerspective:function(){return this.perspective;},setCurrentPerspective:function(oPerspective){this.perspective=oPerspective;},addHandlers:function(oHandlers){for(var h in oHandlers){if(oHandlers.hasOwnProperty(h)){this.addEventListener(h,oHandlers[h]);}}},removeHandlers:function(oHandlers){for(var h in oHandlers){if(oHandlers.hasOwnProperty(h)){this.removeEventListener(h,oHandlers[h]);}}},processConfig:function(){try{var sConfig=this.getPreference('config');if(sConfig){var config=JSON.parse(sConfig);b$.mixin(this,config);}}catch(e){console.log('Error parsing config: '+e);}},persistConfig:function(){try{var sConfig=this.getPreference('config');var config=JSON.parse(sConfig);for(var i in config){if(config[i]!==this[i]){config[i]=this[i];}}sConfig=JSON.stringify(config);this.setPreference('config',sConfig);this.model.save();}catch(e){console.log('Error persisting config: '+e);}},addToConfig:function(attr,val){try{var sConfig=this.getPreference('config');var config=JSON.parse(sConfig);config[attr]=val;sConfig=JSON.stringify(config);this.setPreference('config',sConfig);this.model.save();}catch(e){console.log('Error adding preference to config: '+e);}},removeFromConfig:function(attr){try{var sConfig=this.getPreference('config');var config=JSON.parse(sConfig);delete config[attr];sConfig=JSON.stringify(config);this.setPreference('config',sConfig);this.model.save();}catch(e){console.log('Error removing preference from config: '+e);}}});this.portalViewElement=PortalViewElement;function OrderSort(a,b){a=parseInt(a.getOrderPreference())||0;b=parseInt(b.getOrderPreference())||0;return a-b;};function isInside(tx,ty,x,y,w,h){if(tx>=x&&tx<=x+w&&ty>=y&&ty<=y+h)return true;return false;}var layouts=b$.view.bdom.layout;var Application=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.layout=new layouts.NoLayout(this);},{localName:'application',renderDisplay:function(){return this.htmlNode;}});var Portal=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.perspective=this.createPerspective(new PerspectiveType("Dashboard"),new PerspectiveParameters());this.addEventListener('PerspectiveModified',function(oEvent){this.setCurrentPerspective(this.createPerspective(new PerspectiveType(oEvent.newValue),new PerspectiveParameters()));},false,this);},{localName:'portal',injectDisplaySelf:function(){},insertDisplayChild:function(bdom){if(!(bdom.model&&bdom.model._ssr)){b$._private.ssrRootElement.appendChild(bdom.htmlNode);}},attachHTMLChildren:function(){var kids=this.childNodes;for(var i=0;i<kids.length;i++){var elm=kids[i].getHTMLNode();if(!elm.parentNode||elm.parentNode.nodeType!=1)document.body.appendChild(elm);}},showDesignTools:function(){},hideDesignTools:function(){}},{template:function(json){return'<div class="'+this.cls+' '+this.cls+'--area"></div>';}});var Page=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.layout=new layouts.NoLayout(this);this.isPossibleDragTarget=true;},{localName:'page',pageType:undefined,createDisplay:function(){if(!this.htmlNode){this.htmlNode=this.renderDisplay(this.getDisplayModel());};if(!this.htmlAreas){this.htmlAreas=this.getDisplay('area',true);};this.htmlNode.viewController=this;if(!this.htmlAreas||this.htmlAreas.length<=0){this.htmlAreas=[];var area=htmlAPI.findCaptureClass('bp-area',this.htmlNode);if(area[0]){htmlAPI.addClass(area[0],'--area');this.htmlAreas.push(area[0]);}}if(this.model.manageable){this.pageType='master';}else if(this.model.extendedItemName==''){this.pageType='normal';}else{this.pageType='inherited';};},readyHTML:function(){PortalViewElement.prototype.readyHTML.call(this);},showDesignTools:function(){},hideDesignTools:function(){}},{template:function(json){return'<div class="'+this.cls+'"><div class="'+this.cls+'--area"></div></div>';}});var dragIndicator=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.layout=new layouts.AutoLayout(this);this.isPossibleDragTarget=false;this.flex=1;this.area=0;this.order=0;},{localName:'dragIndicator',setHTMLWidthHeight:function(width,height){var elm=this.htmlNode;htmlAPI.setWidthHeightPB(elm,width,height);htmlAPI.setWidthHeightPB(elm.firstChild,width-htmlAPI.getPadding(elm)-htmlAPI.getBorder(elm),height-htmlAPI.getPadding(elm,'tb')-htmlAPI.getBorder(elm,'tb'));},renderDisplay:function(elm){if(!elm){elm=document.createElement('div');elm.className='bp-drag-indicator';elm.innerHTML='<div class="bp-drag-indicator-in"><span class="bp-drag-text"></span></div>';}return elm;},getAreaPreference:function(){return this.area;},getOrderPreference:function(){return this.order;},setAreaPreference:function(v){this.area=v;},setOrderPreference:function(v){this.order=v;}});});b$.module("b$.portal.view.bdom.container",function(){var PortalViewElement=b$.bdom.getNamespace('http://backbase.com/2013/portalView').getClass('portalViewElement');var layouts=b$.view.bdom.layout;var Container=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.layout=new layouts.NoLayout(this);},{localName:'container',createDisplay:function(){if(!this.htmlNode){this.htmlNode=this.renderDisplay(this.getDisplayModel());};if(!this.htmlAreas){this.htmlAreas=this.getDisplay('area',true);};this.htmlNode.viewController=this;},constrainProportions:function(props,segments){var total=0,factor,i,newProps;newProps=props.concat(new Array(segments)).splice(0,segments);for(i=0;i<segments;i++){newProps[i]=Math.round((newProps[i]||0)*100)/100;total+=newProps[i];}if(total===0){for(i=0;i<segments;i++){newProps[i]=Math.round(100/segments*100)/100;}}else if(total!==100){factor=total/100;for(i=0;i<segments;i++){newProps[i]=newProps[i]/factor;}}return newProps;}},{template:function(){return'<div class="bp-container"><div class="bp-area"></div></div>';}});});b$.module("b$.portal.view.bdom.widget",function(){var scope=function(){return this}();var PerspectiveType=b$.view.perspective.PerspectiveType;var PerspectiveParameters=b$.view.perspective.PerspectiveParameters;var Perspective=b$.view.perspective.Perspective;var SimpleURITemplate=b$._private.template.SimpleURITemplate;var htmlAPI=b$._private.htmlAPI;var simpleResponseCache_getData=b$._private.simpleResponseCache_getData;var NS=b$.bdom.getNamespace('http://backbase.com/2013/portalView');var PortalViewElement=NS.getClass('portalViewElement');var Widget=PortalViewElement.extend(function(bdomDocument,node){PortalViewElement.apply(this,arguments);this.id="none";this.flex=1;},{localName:'widget',createDisplay:function(){this.htmlNode=this.renderDisplay();if(this.htmlNode)this.htmlNode.viewController=this;return this.htmlNode;},renderDisplay:function(){var oDocument=document;if(!this.htmlNode){this.htmlNode=b$.portal.view.loadChrome(this,oDocument);}this.bindChromeHandlers();this.htmlAreas=[];this.htmlAreas[0]=htmlAPI.cssSelector('.bp-widget-body',this.htmlNode)[0];return this.htmlNode;},setHTMLWidthHeight:function(width,height){var elm=this.htmlNode;if(width!==undefined){htmlAPI.setWidth(elm,width);}if(height!==undefined){htmlAPI.setHeight(elm,height);htmlAPI.setHeightPB(this.htmlAreas[0],height-this.htmlHead.offsetHeight-this.htmlFoot.offsetHeight);}},DOMReady:function(){var This=this;if(this.ownerDocument.defaultDragHandlers)this.addHandlers(this.ownerDocument.defaultDragHandlers);this.id=this.model.name;if(This.model){This.model.addEventListener('PrefModified',function(ev){if(ev.target===This.model){var pref=ev.relatedNode;if(pref){var oEvent=this.ownerDocument.createEvent('UIEvent');oEvent.initUIEvent('change',true,false,window,null);pref.dispatchEvent(oEvent,false);}}},false,This);This.model.addEventListener('PrefFallback',function(ev){if(ev.target===This.model){This.refreshHTML();}},false,This);this.addEventListener('PerspectiveModified',function(ev){if(ev.target.model===this.model&&(ev.newValue==='Maximized'||ev.newValue==='Widget')){var oEvent=this.ownerDocument.createEvent('MutationEvent');oEvent.initMutationEvent(ev.newValue==='Maximized'?'maximize':'restore',true,false,this,null,null,null,null);this.model.dispatchEvent(oEvent,true);}},false,this);}},bindChromeHandlers:function(){var This=this;htmlAPI.bindEvent(this.htmlNode,'click',function(ev){var target=ev.target;var action;var oPreferenceContainer=htmlAPI.cssSelector('.bp-widget-pref',this)[0];while(true){action=target.getAttribute('data-action');if(action){switch(action){case'widget-preferences':This.dispatchCustomEvent('preferences-form',true,true,{context:This});break;case'widget-maximize':This.setPerspective('Maximized');break;break;case'widget-restore':This.setPerspective('Widget');target.setAttribute('data-action','widget-minimize');break;case'widget-minimize':This.setPerspective('Minimized');target.setAttribute('data-action','widget-restore');break;case'widget-refresh':This.refreshHTML();break;case'widget-close':This.model.destroyAndSave();break;case'pref-ok':var form=htmlAPI.cssSelector('form',oPreferenceContainer)[0];for(var i=0;i<form.elements.length;i++){var elm=form.elements[i];if(elm.type==='text'){if(elm.value!==This.model.getPreference(elm.name)){console.log(elm.name,elm.value);This.model.setPreference(elm.name,elm.value);}}else if(elm.type==='checkbox'){if(elm.checked!==This.model.getPreference(elm.name)){console.log(elm.name,elm.checked);This.model.setPreference(elm.name,elm.checked);}}}This.model.save();oPreferenceContainer.style.display='none';break;case'pref-cancel':oPreferenceContainer.style.display='none';break;}}if(target==ev.currentTarget)break;target=target.parentNode;if(!target)break;}});},setTitle:function(sTitle){this.model.setPreference('title',sTitle);this.model.save();},getDefinition:function(){return{};},setPerspective:function(sPerspectiveType){if(sPerspectiveType!==this.perspective.getType().getName()){this.perspective=new Perspective(new SimpleURITemplate(this.getDefinition().sUrl||this.sSrc,"page"),new PerspectiveType(sPerspectiveType),new PerspectiveParameters());var oEvent=this.ownerDocument.createEvent('MutationEvent');oEvent.initMutationEvent('PerspectiveModified',true,false,this,this.perspective,sPerspectiveType,null,null);this.dispatchEvent(oEvent);}},getContextVariableValue:function(sName){var oParameter=this.perspective.getParameters().getByName(sName);return oParameter&&oParameter.getValue()||"";}});this.Widget=Widget;defaultChrome='<div class="bp-widget Xbp-ui-dragRoot Xbp-ui-dragGrip">'+'<div class="bp-widget-head">'+'</div>'+'<div class="bp-widget-pref"></div>'+'<div class="bp-widget-body"></div>'+'<div class="bp-widget-foot"></div>'+'</div>';var htmlAPI=b$._private.htmlAPI;b$.portal.view.loadChrome=function(bdom,oDocument){var sProfile={'ADMIN':0,'CREATOR':-1,'COLLABORATOR':-2,'CONTRIBUTOR':-3,'CONSUMER':-4};var model=bdom.model;var oData={};if(model)oData=model.getJSON();var widgetChrome=bdom.getAttribute("widgetChrome");if(widgetChrome){widgetChrome=widgetChrome.replace('$(contextRoot)',b$.portal.portalModel.serverURL);oData.widgetTitle=bdom.getAttribute("title");var chromeTmpl=simpleResponseCache_getData(widgetChrome);}else{var chromeTmpl=defaultChrome;}if(model){var secProfile=sProfile[model.securityProfile];oData.showEdit=secProfile>=sProfile['CONTRIBUTOR'];oData.showDelete=secProfile>=sProfile['CREATOR'];oData.enableDND=secProfile>=sProfile['CONTRIBUTOR'];oData.showMaximize=true;}var chromeHTML=htmlAPI.createElementFromString(Mustache.to_html(chromeTmpl,oData),oDocument);return chromeHTML;};});b$.module("b$.portal.view.bdom.widget.backbase",function(){var NS=b$.bdom.getNamespace('http://backbase.com/2013/portalView');var Widget=NS.getClass('widget');var PerspectiveType=b$.view.perspective.PerspectiveType;var PerspectiveParameters=b$.view.perspective.PerspectiveParameters;var Perspective=b$.view.perspective.Perspective;var SimpleURITemplate=b$._private.template.SimpleURITemplate;var htmlAPI=b$._private.htmlAPI;var asyncComponentBuilder=new b$._private.AsyncComponentBuilder();var BackbaseWidget=Widget.extend(null,{localName:'backbaseWidget',createDisplay:function(){this.htmlNode=this.renderDisplay();if(this.htmlNode)this.htmlNode.viewController=this;return this.htmlNode;},renderDisplay:function(){var oDocument=document;if(!this.htmlNode){this.htmlNode=b$.portal.view.loadChrome(this,oDocument);}this.bindChromeHandlers();this.htmlHead=htmlAPI.cssSelector('.bp-widget-head',this.htmlNode)[0];this.htmlFoot=htmlAPI.cssSelector('.bp-widget-foot',this.htmlNode)[0];this.htmlAreas=[];this.htmlAreas[0]=htmlAPI.cssSelector('.bp-widget-body',this.htmlNode)[0];this.body=this.htmlAreas[0];this.buildWidget();return this.htmlNode;},readyHTML:function(){Widget.prototype.readyHTML.call(this);},buildWidget:function(){var sUrl=this.getAttribute('src');sUrl=sUrl.replace('$(contextRoot)',b$.portal.portalModel.serverURL);var This=this;asyncComponentBuilder.buildWidget(sUrl,function(def){This.myDefinition=def;This.includes=def.getIncludesFromDefinition(This);def.getPreferencesFromDefinition(This);var bSSR=(This.body&&This.body.firstChild)?true:false;if(!bSSR){This.body.appendChild(def.getHTMLBodyFromDefinition());}var oHtml=This.body;var oIncludeElements=htmlAPI.cssSelector(".bp-g-include",oHtml);if(oIncludeElements.length){for(var i=0;i<This.includes.length;i++){var include=This.includes[i];include.htmlNode=oIncludeElements[i];include.addEventListener('content',function(){this.htmlNode.innerHTML='';for(var j=0;j<this.content.length;j++){this.htmlNode.appendChild(this.content[j]);}});}}if(This.model){for(var sEventName in def.XListeners){if(def.XListeners.hasOwnProperty(sEventName)){This.model.addEventListener(sEventName,def.XListeners[sEventName],false,This);}}}var myPortal=This.ownerDocument.documentElement;This.perspective=new Perspective(new SimpleURITemplate(This.myDefinition.sUrl,"page"),new PerspectiveType("Dashboard"),new PerspectiveParameters());if(!bSSR){This.refreshIncludes();}if(def.XListeners.load)def.XListeners.load.call(This);});},refreshIncludes:function(){for(var i=0,l=this.includes.length;i<l;i++){this.includes[i].refresh();}},getOriginURI:function(){return this.getDefinition().sUrl;},getDefinition:function(){return this.myDefinition;},getBody:function(){return this;},getIncludes:function(){return this.includes;}});});